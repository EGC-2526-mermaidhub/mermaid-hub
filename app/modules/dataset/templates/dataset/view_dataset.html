{% extends "base_template.html" %}

{% block title %}View dataset{% endblock %}

{% block head_extra %}
<style>
  .option-button {
    display: block;
    width: 100%;
    margin-bottom: 5px;
  }

  .option-button:last-child {
    margin-bottom: 0;
  }
</style>
{% endblock %}

{% block content %}

<div class="row mb-3">

  <div class="col-6">
    <a href="/explore" class="btn btn-primary btn-sm" id="search" style="border-radius: 5px;">
      <i data-feather="search" class="center-button-icon"></i>
      Explore more datasets
    </a>
  </div>

</div>

<div class="row">

  <div class="col-xl-8 col-lg-12 col-md-12 col-sm-12">

    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <h1><b>{{ dataset.ds_meta_data.title }}</b></h1>
          <div>
            <span class="badge bg-secondary">{{ dataset.get_cleaned_diagram_type() }}</span>
          </div>
        </div>
        <p class="text-secondary">{{ dataset.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>

        <div class="row mb-4">

          <div class="col-md-4 col-12">
            <span class=" text-secondary">
              Description
            </span>
          </div>
          <div class="col-md-8 col-12">
            <p class="card-text">{{ dataset.ds_meta_data.description }}</p>
          </div>

        </div>

        <div class="row mb-2">

          <div class="col-md-4 col-12">
            <span class=" text-secondary">
              Uploaded by
            </span>
          </div>
          <div class="col-md-8 col-12">
            <a href="#">{{ dataset.user.profile.surname }}, {{ dataset.user.profile.name }}</a>
          </div>

        </div>

        <div class="row mb-2">

          <div class="col-md-4 col-12">
            <span class=" text-secondary">
              Authors
            </span>
          </div>
          <div class="col-md-8 col-12">
            {% for author in dataset.ds_meta_data.authors %}
            <p class="p-0 m-0">
              {{ author.name }}
              {% if author.affiliation %}
              ({{ author.affiliation }})
              {% endif %}
              {% if author.orcid %}
              ({{ author.orcid }})
              {% endif %}
            </p>
            {% endfor %}
          </div>


        </div>

        <div class="row mb-2">

          <div class="col-md-4 col-12">
            <span class=" text-secondary">
              Status
            </span>
          </div>
          <div class="col-md-8 col-12">
            {% if dataset.ds_meta_data.is_draft %}
            <span class="badge bg-warning text-dark">DRAFT (Not published)</span>
            {% else %}
            <span class="badge bg-success">PUBLISHED</span>
            {% endif %}
          </div>

        </div>

        {% if dataset.ds_meta_data.is_draft %}
        <div class="row mb-3">
          <div class="col-md-4 col-12"></div>
          <div class="col-md-8 col-12">

            <button
              class="btn btn-success btn-sm me-2"
              style="border-radius: 5px;"
              data-bs-toggle="modal"
              data-bs-target="#publishDatasetModal"
            >
              <i data-feather="upload"></i>
              Publish dataset
            </button>
          </div>
        </div>
        {% endif %}

        {% if dataset.ds_meta_data.publication_doi %}
        <div class="row mb-2">
          <div class="col-md-4 col-12">
            <span class="text-secondary">
              Publication DOI
            </span>
          </div>
          <div class="col-md-8 col-12">
            <a href="{{ dataset.ds_meta_data.publication_doi }}">
              {{ dataset.ds_meta_data.publication_doi }}
            </a>
          </div>
        </div>
        {% endif %}

        {% if dataset.ds_meta_data.dataset_doi %}
        <div class="row mb-2">

          <div class="col-md-4 col-12">
            <span class=" text-secondary">
              Zenodo record
            </span>
          </div>

          {% if FLASK_ENV == 'production' %}
          <div class="col-md-8 col-12">
            <a href="https://zenodo.org/records/{{ dataset.ds_meta_data.deposition_id }}" target="_blank">
              https://zenodo.org/records/{{ dataset.ds_meta_data.deposition_id }}
            </a>
          </div>
          {% elif FLASK_ENV == 'development' %}
          <div class="col-md-8 col-12">
            <a href="https://sandbox.zenodo.org/records/{{ dataset.ds_meta_data.deposition_id }}" target="_blank">
              https://sandbox.zenodo.org/records/{{ dataset.ds_meta_data.deposition_id }}
            </a>
          </div>
          {% else %}
          <div class="col-md-8 col-12">
            <a href="https://zenodo.org/records/{{ dataset.ds_meta_data.deposition_id }}" target="_blank">
              https://sandbox.zenodo.org/records/{{ dataset.ds_meta_data.deposition_id }}
            </a>
          </div>
          {% endif %}

        </div>
        {% endif %}
        <div class="row mb-2">

          <div class="col-md-4 col-12">
            <span class=" text-secondary">
              Tags
            </span>
          </div>
          <div class="col-md-8 col-12">
            {% for tag in dataset.ds_meta_data.tags.split(',') %}
            <span class="badge bg-secondary">{{ tag.strip() }}</span>
            {% endfor %}
          </div>

        </div>

        <div class="row mb-2">
          <div class="col-md-4 col-12">
            <span class="text-secondary">Downloads</span>
          </div>
          <div class="col-md-8 col-12">
            <i class="bi bi-download fs-5 text-primary"></i>
            <span class="badge bg-primary fs-6">{{ dataset.download_count }}</span>
          </div>
        </div>

      </div>

      {% if dataset.ds_meta_data.dataset_doi %}
      <div class="card-body" style="padding-top: 0px">

        <div id="dataset_doi_uvlhub" style="display: none">
          {{ dataset.get_mermaidhub_doi() }}
        </div>

        <button type="button" class="btn doi_button btn-sm" onclick="copyText('dataset_doi_uvlhub')">
          <span class="button_doi_id">
            <i data-feather="clipboard" class="center-button-icon" style="cursor: pointer"></i>
            <b>DOI</b>
          </span>
          <span class="doi_text">
            {{ dataset.get_mermaidhub_doi() }}
          </span>
        </button>

        <div id="dataset_doi_uvlhub" style="display: none">
          {{ dataset.get_mermaidhub_doi() }}
        </div>

      </div>
      {% endif %}

    </div>

  </div>

  <div class="col-xl-4 col-lg-12 col-md-12 col-sm-12">

    <div class="list-group">

      <div class="list-group-item">

        <div class="row">
          <div class="col-12 d-flex justify-content-between align-items-center">
            <h4 style="margin-bottom: 0px">Mermaid models</h4>
            <h4 style="margin-bottom: 0px;"><span class="badge bg-dark">{{ dataset.get_files_count() }}</span></h4>
          </div>
        </div>


      </div>


      {% for mermaid_diagram in dataset.mermaid_diagrams %}
      {% for file in mermaid_diagram.files %}
      <div class="list-group-item">

        <div class="row">
          <div class="col-12">

            <div class="row">
              <div class="col-8">
                <i data-feather="file"></i> {{ file.name }}
                <br>
                <small class="text-muted">({{ file.get_formatted_size() }})</small>
              </div>
              <!-- check output removed (flamapy not used) -->
            </div>


          </div>
          <div class="col-12 text-end">

            <button onclick="viewFile('{{ file.id }}')" class="btn btn-outline-secondary btn-sm"
              style="border-radius: 5px;">
              <i data-feather="eye"></i> View
            </button>

            <!-- Check button removed because flamapy is not used -->

            <div class="btn-group" role="group">
              <button id="btnGroupDropExport{{ file.id }}" type="button" class="btn btn-primary btn-sm dropdown-toggle"
                data-bs-toggle="dropdown" aria-expanded="false" style=" border-radius: 5px;">
                <i data-feather="download"></i> Export
              </button>
              <ul class="dropdown-menu" aria-labelledby="btnGroupDropExport{{ file.id }}">
                <li>
                  <a class="dropdown-item" href="{{ url_for('hubfile.download_file', file_id=file.id) }}">
                    Mermaid (.mmd)
                  </a>
                </li>
              </ul>
            </div>



          </div>
        </div>
      </div>
      {% endfor %}
      {% endfor %}
    </div>



    <a href="/dataset/download/{{ dataset.id }}" class="btn btn-primary mt-3" style="border-radius: 5px;">
      <i data-feather="download" class="center-button-icon"></i>
      Download all ({{ dataset.get_file_total_size_for_human() }})
    </a>
  </div>

</div>

<!-- Modal-->
<div class="modal fade" id="fileViewerModal" tabindex="-1" aria-labelledby="fileViewerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" style="height: 80vh; display: flex; align-items: center;">
    <div class="modal-content" style="height: 80vh;">
      <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h5 class="modal-title" id="fileViewerModalLabel">Mermaid diagram view</h5>
        <div>
          <a href="#" class="btn btn-outline-primary btn-sm" id="downloadButton"
            style="margin-right: 5px; margin-bottom: 5px; border-radius: 5px;">
            <i data-feather="download"></i>
          </a>
          <button onclick="copyToClipboard()" class="btn btn-outline-secondary btn-sm"
            style="margin-right: 5px; margin-bottom: 5px; border-radius: 5px;">
            <i data-feather="copy"></i>
          </button>
          <button id="visualizeButton" class="btn btn-outline-success btn-sm"
            style="margin-right:5px; margin-bottom:5px; border-radius:5px;">
            <i data-feather="play"></i> Visualize diagram
          </button>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
      </div>
      <div class="modal-body" style="overflow-y: auto; height: calc(100vh - 50px);">
        <pre id="fileContent"
          style="height: 100%; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; background-color: #f5f5f5; padding: 20px; border-radius: 5px; border: 1px solid #ccc;"></pre>
        <div id="mermaidContainer"
          style="display:none; padding:20px; background-color: white; border-radius:5px; border:1px solid #ccc;"></div>
        <div id="mermaidSpinner" style="display:none; position: absolute; right: 40px; top: 20px; z-index: 1051;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<div class="card mt-4">
  <div class="card-body">
    <h3 class="mb-3"><b>Recommended datasets</b></h3>
    <p class="text-secondary mb-4">Based on similar tags, authors or diagram types</p>

    <div class="row g-3">
      {% for rec in recommended_datasets %}
      <div class="col-12 col-md-6 col-xl-4">
        <div class="card h-100 shadow rounded-3 border">
          
          <div class="card-header bg-light d-flex align-items-center justify-content-between p-3">
            
            <div class="d-flex flex-column me-2">
              <h6 class="card-title mb-1 text-primary">
                <a href="{{ url_for('dataset.subdomain_index', doi=rec.ds_meta_data.dataset_doi) }}" class="text-decoration-none fw-bold">
                  {{ rec.ds_meta_data.title }}
                </a>
              </h6>
              <span class="badge bg-secondary text-wrap" style="width: fit-content; font-size: 0.7rem;">
                {{ rec.get_cleaned_diagram_type() }}
              </span>
            </div>

            {% if rec.ds_meta_data.authors %}
              {% set first_author = rec.ds_meta_data.authors[0] %}
              <div class="text-end ms-auto">
                <small class="text-muted">
                  {% if first_author.name %}
                    {{ first_author.name }}
                  {% else %}
                    N/A
                  {% endif %}
                </small>
              </div>
            {% endif %}

          </div>

          <div class="card-footer bg-light p-3">
            <a href="{{ url_for('dataset.subdomain_index', doi=rec.ds_meta_data.dataset_doi) }}"
               class="btn btn-outline-primary btn-sm w-100 rounded-pill">
               View Dataset
            </a>
          </div>

        </div>
      </div>
      {% endfor %}

      {% if recommended_datasets|length == 0 %}
      <div class="col-12">
        <p class="text-muted">No recommendations available.</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script type="text/javascript" src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>



<script>
  document.addEventListener('DOMContentLoaded', function () {
    feather.replace();
  });

  var currentFileId;
  var currentFileContent = '';
  var mermaidLoaded = false;

  function viewFile(fileId) {
    fetch(`/file/view/${fileId}`)
      .then(response => response.json())
      .then(data => {
        document.getElementById('fileContent').textContent = data.content;
        currentFileContent = data.content || '';
        currentFileId = fileId;
        document.getElementById('downloadButton').href = `/file/download/${fileId}`;
        var modal = new bootstrap.Modal(document.getElementById('fileViewerModal'));
        modal.show();
      })
      .catch(error => console.error('Error loading file:', error));
  }

  function ensureMermaidLoaded(callback) {
    if (mermaidLoaded) {
      callback();
      return;
    }
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js';
    script.onload = () => {
      try {
        mermaid.initialize({ startOnLoad: false, securityLevel: 'loose' });
      } catch (e) {
        console.warn('Mermaid init failed', e);
      }
      mermaidLoaded = true;
      callback();
    };
    script.onerror = () => {
      console.error('Failed to load mermaid.js');
      alert('Could not load mermaid renderer.');
    };
    document.head.appendChild(script);
  }

  document.getElementById('visualizeButton').addEventListener('click', function () {
    const pre = document.getElementById('fileContent');
    const container = document.getElementById('mermaidContainer');
    const btn = document.getElementById('visualizeButton');

    if (container.style.display === 'block') {
      container.style.display = 'none';
      pre.style.display = 'block';
      btn.innerHTML = '<i data-feather="play"></i> Visualize diagram';
      feather.replace();
      return;
    }

    if (!currentFileContent || currentFileContent.trim() === '') {
      alert('No file content to render');
      return;
    }

    ensureMermaidLoaded(() => {
      const renderId = 'mermaid-' + (currentFileId || Date.now()) + '-' + Date.now();
      try {
        const renderResult = mermaid.render(renderId, currentFileContent);
        if (renderResult && renderResult.then) {
          renderResult.then(obj => {
            container.innerHTML = obj.svg || obj;
            pre.style.display = 'none';
            container.style.display = 'block';
            btn.innerHTML = 'Show source';
          }).catch(err => {
            console.error('Mermaid render error', err);
            alert('Error rendering diagram: ' + err.message);
          });
        } else {
          container.innerHTML = renderResult || '';
          pre.style.display = 'none';
          container.style.display = 'block';
          btn.innerHTML = 'Show source';
        }
      } catch (err) {
        console.error('Mermaid render exception', err);
        alert('Error rendering diagram: ' + (err && err.message ? err.message : err));
      }
    });
  });

  function showLoading() {
    document.getElementById("loading").style.display = "initial";
  }

  function hideLoading() {
    document.getElementById("loading").style.display = "none";
  }

  // checkUVL removed because flamapy is not used


  /*
  async function valid() {
      showLoading()
      let pyodide = await loadPyodide();
      await pyodide.loadPackage("micropip");
      const micropip = pyodide.pyimport("micropip");
      //await micropip.install("/assets/web_assembly/antlr4_python3_runtime-4.7.2-py3-none-any.whl");
      await micropip.install("antlr4-python3-runtime==4.13.1");
      await micropip.install("uvlparser==2.0.1");
      //await micropip.install("afmparser==1.0.0");

      await pyodide.runPythonAsync(
      `
          import micropip
          #await micropip.install("flamapy-fm-dist", deps=False)#this is to avoid problems with deps later on
          await micropip.install("flamapy==2.0.1.dev1", deps=False);
          await micropip.install("flamapy-fm==2.0.1.dev1", deps=False);
          await micropip.install("flamapy-sat");
      `
      )
      hideLoading()

      try {
          let output = pyodide.runPython(
          `
          import js

          file_content = js.document.getElementById('fileContent').textContent 
          div = js.document.createElement("result")

          with open("uvlfile.uvl", "w") as text_file:
              print(file_content, file=text_file)

          from flamapy.interfaces.python.FLAMAFeatureModel import FLAMAFeatureModel

          fm = FLAMAFeatureModel("uvlfile.uvl")
          result=fm.valid()

          div.innerHTML = "<div id='deleteme'>"+str(result)+"</div>"
          exists=js.document.getElementById('deleteme')
          if(exists):
              exists.remove()

          js.document.getElementById('result').append(div)
          `
      );
      } catch (err) {
          console.log(err);
      }
  }
  */
  function copyToClipboard() {
    const text = document.getElementById('fileContent').textContent;
    navigator.clipboard.writeText(text).then(() => {
      console.log('Text copied to clipboard');
    }).catch(err => {
      console.error('Failed to copy text: ', err);
    });
  }
</script>



{% if dataset.ds_meta_data.is_draft and current_user.is_authenticated %}

<div class="modal fade" id="publishDatasetModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Publish dataset</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p>
          This action will publish the dataset to Zenodo and make it publicly available.
        </p>
        <p class="text-danger mb-0">
          This operation <b>cannot be undone</b>.
        </p>
      </div>

      <div class="modal-footer">

        <form method="POST"
              action="{{ url_for('dataset.publish_dataset', dataset_id=dataset.id) }}">

          {{ form.csrf_token }}

          <button type="submit" class="btn btn-success">
            <i data-feather="upload"></i> Confirm publish
          </button>

        </form>

        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>

      </div>
    </div>
  </div>
</div>

{% endif %}

{% endblock %}