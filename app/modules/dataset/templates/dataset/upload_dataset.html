{% extends "base_template.html" %}

{% block title %}Upload dataset{% endblock %}

{% block content %}

    <h1 class="h2 mb-3"><b>Upload</b> dataset</h1>

    <div class="row">
        <div class="col-12 mb-3">
            <div class="alert alert-warning" role="alert" id="test_zenodo_connection_error" style="display: none">
                <div class="alert-message">

                    <h4 class="alert-heading"><i class="align-middle" data-feather="alert-triangle"></i> Limited
                        connection to the Zenodo API</h4>
                    <p class="p-0 m-0">
                        There seems to be some kind of problem with the Zenodo API and synchronization of your dataset
                        files may not be possible. We will save your files locally to eventually synchronize them with
                        Zenodo. Sorry for the inconvenience, Zenodo is an external service and we can't do
                        anything about it.
                    </p>
                </div>
            </div>
        </div>

    </div>

    {% if messages %}
        <ul>
            {% for message in messages %}
                <li>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <div class="row">

        <div class="col-xl-6 col-lg-12 col-md-12 col-sm-12">
            <div id="basic_info_form">

                {{ form.hidden_tag() }}

                <div class="row">

                    <div class="col-12">

                        <h1 class="h3 mb-3">Basic info</h1>

                        <div class="row" style="padding-left: 2rem">

                            <div class="col-lg-6 col-xs-12 col-md-12">
                                <div class="mb-3">
                                    {{ form.title.label(class="form-label") }} *
                                    {{ form.title(class="form-control") }}
                                    {% for error in form.title.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="mb-3">
                                    {{ form.desc.label(class="form-label") }} *
                                    {{ form.desc(rows=4, class="form-control") }}
                                    {% for error in form.desc.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-lg-6 col-6">
                                <div class="mb-3">
                                    <label class="form-label">Diagram type</label>
                                    {{ form.diagram_type(class="form-control") }}
                                </div>

                            </div>

                            {# publication_doi removed: DOI will be provided by backend after upload #}

                            <div class="col-6">
                                <div class="mb-3">
                                    {{ form.tags.label(class="form-label") }}
                                    {{ form.tags(class="form-control") }}
                                    {% for error in form.tags.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                        </div>

                        <h1 class="h3 mb-3 mt-4">
                          Authors
                          <a href="#" data-toggle="modal" data-target="#infoModal">
                            <i data-feather="info"></i> <!-- Usamos "info" porque Feather no tiene un ícono específico llamado "feather" para más info -->
                          </a>
                        </h1>

                        <!-- Modal -->
                        <div class="modal fade" id="infoModal" tabindex="-1" role="dialog" aria-labelledby="infoModalLabel" aria-hidden="true" style="display: none">
                          <div class="modal-dialog" role="document">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title" id="infoModalLabel">Información Importante</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                  <span aria-hidden="true">&times;</span>
                                </button>
                              </div>
                              <div class="modal-body">
                                ¡Cuidado! Los autores no se pueden editar una vez que el dataset se haya subido a UVLHub. Esta funcionalidad estará disponible para futuras versiones.
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div class="row" style="padding-left: 2rem">

                            <div class="col-lg-6 col-12 mb-3">
                                <label class="form-label">Author name</label>
                                <input class="form-control"
                                       disabled
                                       value="{{ current_user.profile.surname }}, {{ current_user.profile.name }}">
                            </div>

                            <div class="col-lg-6 col-12 mb-3">
                                <label class="form-label">Author affiliation</label>
                                <input class="form-control"
                                       disabled value="{{ current_user.profile.affiliation }}">
                            </div>

                            <div class="col-lg-6 col-12 mb-3">
                                <label class="form-label">Author ORCID</label>
                                <input class="form-control"
                                       disabled value="{{ current_user.profile.orcid }}">
                            </div>

                            <div class="col-12">

                                <div class="mb-3">

                                    <div id="authors">
                                        {% for subform in form.authors %}
                                        <div class="row author" {% if not loop.first %}
                                            style="border:2px dotted #ccc;border-radius:10px;padding:10px;margin:10px 0; background-color: white"
                                            {% endif %}
                                        >
                                            <div class="col-lg-6 col-12 mb-3">
                                                {{ subform.form.name.label(class="form-label") }}
                                                {{ subform.form.name(class="form-control", disabled=loop.first) }}
                                                {% for error in subform.name.errors %}
                                                    <span style="color: red;">{{ error }}</span>
                                                {% endfor %}
                                            </div>

                                            <div class="col-lg-6 col-12 mb-3">
                                                {{ subform.form.affiliation.label(class="form-label") }}
                                                {{ subform.form.affiliation(class="form-control", disabled=loop.first) }}
                                                {% for error in subform.name.errors %}
                                                    <span style="color: red;">{{ error }}</span>
                                                {% endfor %}
                                            </div>

                                            <div class="col-lg-6 col-12 mb-3">
                                                {{ subform.orcid.label(class="form-label") }}
                                                {{ subform.orcid(class="form-control", disabled=loop.first) }}
                                                {% for error in subform.orcid.errors %}
                                                    <span style="color: red;">{{ error }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <button type="button" class="btn btn-secondary" id="add_author">Add author
                                    </button>

                                </div>

                            </div>


                        </div>

                    </div>

                </div>

                <div class="row">

                    {% if error %}

                        <div class="mt-3 col-lg-6 col-12">
                            <span style="color: red;">{{ error }}</span>
                        </div>

                    {% endif %}

                </div>


            </div>
        </div>

        <div class="col-xl-6 col-lg-12 col-md-12 col-sm-12">

                        <h1 class="h3 mb-3 mt-2">Mermaid models</h1>

            <div id="uploaded_models_form" style="padding-left: 2rem">

                <div class="dropdown mb-2 d-inline-block">
                    <button type="button" class="btn btn-outline-primary dropdown-toggle" id="githubImportDropdown" aria-haspopup="true" aria-expanded="false">
                         Import from GitHub
                     </button>
                     <div class="dropdown-menu p-3" aria-labelledby="githubImportDropdown" style="min-width: 320px;">
                         <form id="githubImportForm" class="github-import-form">
                            <div class="form-group">
                                <label for="github_repo">Repository URL</label>
                                <input type="text" class="form-control" id="github_repo" name="repo_url" placeholder="https://github.com/owner/repo.git" required>
                            </div>
                            <div class="form-group">
                                <label for="github_branch">Branch (optional)</label>
                                <input type="text" class="form-control" id="github_branch" name="branch" placeholder="main">
                            </div>
                            <div class="form-group">
                                <label for="github_path">Path inside repo (optional)</label>
                                <input type="text" class="form-control" id="github_path" name="path" placeholder="folder/subfolder">
                            </div>
                            <div class="form-group">
                                <label for="github_token">GitHub token (optional)</label>
                                <input type="password" class="form-control" id="github_token" name="token" placeholder="token for private repos">
                            </div>
                            <div class="d-flex justify-content-between">
                                <button type="submit" class="btn btn-sm btn-primary">Load files</button>
                                <!-- Add id so we can close the dropdown with vanilla JS -->
                                <button type="button" class="btn btn-sm btn-secondary" id="githubImportClose">Close</button>
                            </div>
                         </form>
                     </div>
                 </div>

                 <form action="{{ url_for('dataset.upload') }}" class="dropzone" id="myDropzone">
                     <div id="dropzone-text"></div>
                 </form>

                 <span class="text-danger" id="alerts" style="display: none">
                     </span>

                 <ul class="mt-2" id="file-list"></ul>

                 <script>

                    // Simple dropdown controller (works without Bootstrap JS/jQuery)
                    (function () {
                        const toggleBtn = document.getElementById('githubImportDropdown');
                        if (!toggleBtn) return;
                        const menu = toggleBtn.nextElementSibling;
                        toggleBtn.addEventListener('click', function (ev) {
                            ev.stopPropagation();
                            menu.classList.toggle('show');
                            const expanded = toggleBtn.getAttribute('aria-expanded') === 'true';
                            toggleBtn.setAttribute('aria-expanded', String(!expanded));
                        });
                        const closeBtn = document.getElementById('githubImportClose');
                        if (closeBtn) {
                            closeBtn.addEventListener('click', function (ev) {
                                ev.preventDefault();
                                menu.classList.remove('show');
                                toggleBtn.setAttribute('aria-expanded', 'false');
                            });
                        }
                        document.addEventListener('click', function (ev) {
                            if (!menu.classList.contains('show')) return;
                            if (!menu.contains(ev.target) && ev.target !== toggleBtn) {
                                menu.classList.remove('show');
                                toggleBtn.setAttribute('aria-expanded', 'false');
                            }
                        });
                    })();

                    if (!window._gh_file_counter) window._gh_file_counter = 0;
                    function _localGenerateIncrementalId() {
                        if (typeof generateIncrementalId === 'function') {
                            try { return generateIncrementalId(); } catch (e) {}
                        }
                        window._gh_file_counter += 1;
                        return window._gh_file_counter;
                    }

                    function addUploadedFile(filename) {
                        try { show_upload_dataset(); } catch (e) {}

                        let fileList = document.getElementById('file-list');
                        let listItem = document.createElement('li');
                        let h4Element = document.createElement('h4');
                        h4Element.textContent = filename;
                        listItem.appendChild(h4Element);

                        let formUniqueId = _localGenerateIncrementalId();

                        // FORM BUTTON
                        let formButton = document.createElement('button');
                        formButton.innerHTML = 'Show info';
                        formButton.classList.add('info-button', 'btn', 'btn-outline-secondary', 'btn-sm');
                        formButton.style.borderRadius = '5px';
                        formButton.id = formUniqueId + "_button";

                        // CONTAINER
                        let formContainer = document.createElement('div');
                        formContainer.id = formUniqueId + "_form";
                        formContainer.classList.add('uvl_form', 'mt-3');
                        formContainer.style.display = "none";

                        formButton.addEventListener('click', function () {
                            if (formContainer.style.display === "none") {
                                formContainer.style.display = "block";
                                formButton.innerHTML = 'Hide info';
                            } else {
                                formContainer.style.display = "none";
                                formButton.innerHTML = 'Add info';
                            }
                        });

                        // REMOVE BUTTON
                        let removeButton = document.createElement('button');
                        removeButton.innerHTML = 'Delete model';
                        removeButton.classList.add('btn', 'btn-outline-danger', 'btn-sm', 'remove-button');
                        removeButton.style.borderRadius = '5px';

                        removeButton.addEventListener('click', function () {
                            if (fileList.contains(listItem)) fileList.removeChild(listItem);

                            let xhr = new XMLHttpRequest();
                            xhr.open('POST', '/dataset/file/delete', true);
                            xhr.setRequestHeader('Content-Type', 'application/json');
                            xhr.onload = function () {
                                if (xhr.status === 200) {
                                    console.log('Deleted file from server');
                                    if (!document.getElementById('file-list').children.length) {
                                        try { document.getElementById("upload_dataset").style.display = "none"; } catch (e) {}
                                        try { clean_upload_errors(); } catch (e) {}
                                    }
                                }
                            };
                            xhr.send(JSON.stringify({file: filename}));
                        });

                        formContainer.innerHTML = `
                            <div class="row">
                                <input type="hidden" value="${filename}" name="mermaid_diagrams-${formUniqueId}-mmd_filename">
                                <div class="col-12">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="mb-3">
                                                <label class="form-label">Title</label>
                                                <input type="text" class="form-control" name="mermaid_diagrams-${formUniqueId}-title">
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="mb-3">
                                                <label class="form-label">Description</label>
                                                <textarea rows="4" class="form-control" name="mermaid_diagrams-${formUniqueId}-desc"></textarea>
                                            </div>
                                        </div>
                                        <div class="col-lg-6 col-12">
                                            <div class="mb-3">
                                                <label class="form-label" for="diagram_type">Diagram type</label>
                                                <select class="form-control" name="mermaid_diagrams-${formUniqueId}-diagram_type">
                                                    <option value="NONE">None</option>
                                                    <option value="FLOWCHART">Flowchart</option>
                                                    <option value="SEQUENCE_DIAGRAM">Sequence diagram</option>
                                                    <option value="CLASS_DIAGRAM">Class diagram</option>
                                                    <option value="STATE_DIAGRAM">State diagram</option>
                                                    <option value="ENTITY_RELATIONSHIP_DIAGRAM">Entity-relationship diagram</option>
                                                    <option value="USER_JOURNEY">User journey</option>
                                                    <option value="GANTT">Gantt</option>
                                                    <option value="PIE_CHART">Pie chart</option>
                                                    <option value="QUADRANT_CHART">Quadrant chart</option>
                                                    <option value="REQUIREMENT_DIAGRAM">Requirement diagram</option>
                                                    <option value="GITGRAPH_DIAGRAM">Gitgraph diagram</option>
                                                    <option value="C4_DIAGRAM">C4 diagram</option>
                                                    <option value="MINDMAPS">Mindmaps</option>
                                                    <option value="TIMELINE">Timeline</option>
                                                    <option value="ZENUML">ZenUML</option>
                                                    <option value="SANKEY">Sankey</option>
                                                    <option value="XYCHART">XY chart</option>
                                                    <option value="BLOCKDIAGRAM">Block diagram</option>
                                                    <option value="PACKET">Packet</option>
                                                    <option value="KANBAN">Kanban</option>
                                                    <option value="ARCHITECTURE">Architecture</option>
                                                    <option value="RADAR">Radar</option>
                                                    <option value="TREEMAP">Treemap</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="mb-3">
                                                <label class="form-label">Tags (separated by commas)</label>
                                                <input type="text" class="form-control" name="mermaid_diagrams-${formUniqueId}-tags">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="mb-3">
                                                <label class="form-label">Mermaid version</label>
                                                <input type="text" class="form-control" name="mermaid_diagrams-${formUniqueId}-version">
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="mb-3">
                                                <label class="form-label">Authors</label>
                                                <div id="${formContainer.id}_authors"></div>
                                                <button type="button" class="add_author_to_uvl btn btn-secondary" id="${formContainer.id}_authors_button">Add author</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;

                        listItem.appendChild(formButton);
                        listItem.appendChild(removeButton);
                        listItem.appendChild(formContainer);
                        fileList.appendChild(listItem);
                    }

                    document.getElementById('githubImportForm').addEventListener('submit', function (ev) {
                        ev.preventDefault();
                        const repo = document.getElementById('github_repo').value.trim();
                        const branch = document.getElementById('github_branch').value.trim() || 'main';
                        const path = document.getElementById('github_path').value.trim();
                        const token = document.getElementById('github_token').value;

                        const alerts = document.getElementById('alerts');
                        alerts.innerHTML = '';
                        alerts.style.display = 'none';

                        if (!repo) {
                            alerts.textContent = 'Repository URL is required';
                            alerts.style.display = 'block';
                            return;
                        }

                        const submitBtn = this.querySelector('button[type="submit"]');
                        submitBtn.disabled = true;
                        const payload = { repo_url: repo, branch: branch, path: path, token: token };

                        fetch('/dataset/file/upload_github', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                        }).then(async (resp) => {
                            submitBtn.disabled = false;
                            if (!resp.ok) {
                                const data = await resp.json().catch(() => ({}));
                                const msg = data.message || 'Error loading files from GitHub';
                                alerts.textContent = msg;
                                if (Array.isArray(data.errors) && data.errors.length) {
                                    const ul = document.createElement('ul');
                                    data.errors.forEach(e => { let li = document.createElement('li'); li.textContent = e; ul.appendChild(li); });
                                    alerts.appendChild(ul);
                                }
                                alerts.style.display = 'block';
                                return;
                            }
                            const data = await resp.json();

                            if (Array.isArray(data.errors) && data.errors.length) {
                                data.errors.forEach(e => {
                                    let p = document.createElement('p');
                                    p.textContent = e;
                                    alerts.appendChild(p);
                                });
                                alerts.style.display = 'block';
                            }

                            if (Array.isArray(data.filenames)) {
                                data.filenames.forEach(fn => addUploadedFile(fn));
                            }
                            try {
                                const toggleBtn = document.getElementById('githubImportDropdown');
                                const menu = toggleBtn && toggleBtn.nextElementSibling;
                                if (menu) menu.classList.remove('show');
                                if (toggleBtn) toggleBtn.setAttribute('aria-expanded', 'false');
                            } catch (e) {}
                        }).catch((err) => {
                            submitBtn.disabled = false;
                            alerts.textContent = 'Error contacting server: ' + err;
                            alerts.style.display = 'block';
                        });
                    });

                     function ensureMermaidLoaded(callback) {
                         if (window.mermaid) return callback(null);
                         const s = document.createElement('script');
                         s.src = 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js';
                         s.onload = function () {
                             try {
                                 if (window.mermaid && mermaid.initialize) {
                                     mermaid.initialize({ startOnLoad: false });
                                 }
                             } catch (e) {
                             }
                             callback(null);
                         };
                         s.onerror = function () {
                             callback(new Error('Could not load mermaid library'));
                         };
                         document.head.appendChild(s);
                     }

                     function validateMermaidText(text) {
                         try {
                             if (window.mermaid && mermaid.parse) {
                                 mermaid.parse(text);
                                 return null;
                             }
                             return null;
                         } catch (err) {
                             return err && err.message ? err.message : String(err);
                         }
                     }

                     function extractMermaidBlocks(text) {
                         const lines = text.split(/\r?\n/);
                         const keywords = [
                             'graph', 'flowchart', 'sequenceDiagram', 'classDiagram', 'stateDiagram', 'pie', 'gantt',
                             'erDiagram', 'journey', 'gitGraph', 'gitgraph', 'c4', 'mindmap', 'timeline', 'sankey', 'radar'
                         ];
                         const blocks = [];
                         let current = null;

                         const isStart = (line) => {
                             if (!line) return false;
                             const l = line.trim();
                             for (const kw of keywords) {
                                 const re = new RegExp('^' + kw + '\\b', 'i');
                                 if (re.test(l)) return true;
                             }
                             return false;
                         };

                         for (const line of lines) {
                             if (isStart(line)) {
                                 if (current !== null) {
                                     blocks.push(current.join('\n'));
                                 }
                                 current = [line];
                             } else {
                                 if (current !== null) current.push(line);
                             }
                         }
                         if (current !== null) blocks.push(current.join('\n'));
                         return blocks;
                     }

                     let dropzone = Dropzone.options.myDropzone = {
                         url: "/dataset/file/upload",
                         paramName: 'file',
                         maxFilesize: 10,
                         acceptedFiles: '.mmd',
                         accept: function(file, done) {
                             const alerts = document.getElementById('alerts');
                             const ext = file.name.split('.').pop();
                             if (ext !== 'mmd') {
                                 const msg = 'Invalid file extension: ' + file.name + ' (use .mmd)';
                                 let alert = document.createElement('p');
                                 alert.textContent = msg;
                                 alerts.appendChild(alert);
                                 alerts.style.display = 'block';
                                 done(msg);
                                 const dz = this;
                                 setTimeout(() => dz.removeFile(file), 10);
                                 return;
                             }

                             const reader = new FileReader();
                             reader.onload = (e) => {
                                 const content = e.target.result;
                                 ensureMermaidLoaded((loadErr) => {
                                     if (loadErr) {
                                         console.warn('mermaid validation skipped:', loadErr);
                                         done();
                                         return;
                                     }
                                     const blocks = extractMermaidBlocks(content);
                                     if (!blocks || blocks.length === 0) {
                                         const msg = 'No Mermaid diagram detected in ' + file.name;
                                         let alert = document.createElement('p');
                                         alert.textContent = msg;
                                         alerts.appendChild(alert);
                                         alerts.style.display = 'block';
                                         done(msg);
                                         setTimeout(() => this.removeFile(file), 10);
                                         return;
                                     }
                                     if (blocks.length > 1) {
                                         const msg = 'Multiple Mermaid diagrams detected in ' + file.name + '. Please upload one diagram per file.';
                                         let alert = document.createElement('p');
                                         alert.textContent = msg;
                                         alerts.appendChild(alert);
                                         alerts.style.display = 'block';
                                         done(msg);
                                         setTimeout(() => this.removeFile(file), 10);
                                         return;
                                     }
                                     const errMsg = validateMermaidText(blocks[0]);
                                     if (errMsg) {
                                         const msg = 'Mermaid syntax error in ' + file.name + ': ' + errMsg;
                                         let alert = document.createElement('p');
                                         alert.textContent = msg;
                                         alerts.appendChild(alert);
                                         alerts.style.display = 'block';
                                         done(msg);
                                         setTimeout(() => this.removeFile(file), 10);
                                         return;
                                     }
                                     done();
                                 });
                             };
                             reader.onerror = () => {
                                 const msg = 'Could not read file ' + file.name;
                                 let alert = document.createElement('p');
                                 alert.textContent = msg;
                                 alerts.appendChild(alert);
                                 alerts.style.display = 'block';
                                 done(msg);
                                 setTimeout(() => this.removeFile(file), 10);
                             };
                             reader.readAsText(file);
                         },

                         init: function () {

                             let fileList = document.getElementById('file-list');
                             let dropzoneText = document.getElementById('dropzone-text');
                             let alerts = document.getElementById('alerts');


                             this.on('success', function (file, response) {

                                let dropzone = this;

                                show_upload_dataset();

                                console.log("File uploaded: ", response);
                                let listItem = document.createElement('li');
                                let h4Element = document.createElement('h4');
                                h4Element.textContent = response.filename;
                                listItem.appendChild(h4Element);

                                let formUniqueId = generateIncrementalId();

                                /*
                                    ##########################################
                                    FORM BUTTON
                                    ##########################################
                                */
                                let formButton = document.createElement('button');
                                formButton.innerHTML = 'Show info';
                                formButton.classList.add('info-button', 'btn', 'btn-outline-secondary', "btn-sm");
                                formButton.style.borderRadius = '5px';
                                formButton.id = formUniqueId + "_button";

                                formButton.addEventListener('click', function () {
                                    if (formContainer.style.display === "none") {
                                        formContainer.style.display = "block";
                                        formButton.innerHTML = 'Hide info';
                                    } else {
                                        formContainer.style.display = "none";
                                        formButton.innerHTML = 'Add info';
                                    }
                                });

                                // append space
                                let space = document.createTextNode(" ");
                                listItem.appendChild(space);

                                /*
                                    ##########################################
                                    REMOVE BUTTON
                                    ##########################################
                                */

                                // remove button
                                let removeButton = document.createElement('button');
                                removeButton.innerHTML = 'Delete model';
                                removeButton.classList.add("remove-button", "btn", "btn-outline-danger", "btn-sm", "remove-button");
                                removeButton.style.borderRadius = '5px';

                                // append space
                                space = document.createTextNode(" ");
                                listItem.appendChild(space);

                                removeButton.addEventListener('click', function () {
                                    fileList.removeChild(listItem);
                                    this.removeFile(file);

                                    // Ajax request
                                    let xhr = new XMLHttpRequest();
                                    xhr.open('POST', '/dataset/file/delete', true);
                                    xhr.setRequestHeader('Content-Type', 'application/json');
                                    xhr.onload = function () {
                                        if (xhr.status === 200) {
                                            console.log('Deleted file from server');

                                            if (dropzone.files.length === 0) {
                                                document.getElementById("upload_dataset").style.display = "none";
                                                clean_upload_errors();
                                            }

                                        }
                                    };
                                    xhr.send(JSON.stringify({file: file.name}));
                                }.bind(this));

                                /*
                                    ##########################################
                                    APPEND BUTTONS
                                    ##########################################
                                */
                                listItem.appendChild(formButton);
                                listItem.appendChild(removeButton);

                                /*
                                    ##########################################
                                    UVL FORM
                                    ##########################################
                                */

                                // create specific form for Mermaid
                                let formContainer = document.createElement('div');
                                formContainer.id = formUniqueId + "_form";
                                formContainer.classList.add('uvl_form', "mt-3");
                                formContainer.style.display = "none";

                                formContainer.innerHTML = `
                                    <div class="row">
                                        <input type="hidden" value="${response.filename}" name="mermaid_diagrams-${formUniqueId}-mmd_filename">
                                        <div class="col-12">
                                            <div class="row">
                                                <div class="col-12">
                                                    <div class="mb-3">
                                                        <label class="form-label">Title</label>
                                                        <input type="text" class="form-control" name="mermaid_diagrams-${formUniqueId}-title">
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="mb-3">
                                                        <label class="form-label">Description</label>
                                                        <textarea rows="4" class="form-control" name="mermaid_diagrams-${formUniqueId}-desc"></textarea>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6 col-12">
                                                    <div class="mb-3">
                                                        <label class="form-label" for="diagram_type">Diagram type</label>
                                                        <select class="form-control" name="mermaid_diagrams-${formUniqueId}-diagram_type">
                                                            <option value="NONE">None</option>
                                                            <option value="FLOWCHART">Flowchart</option>
                                                            <option value="SEQUENCE_DIAGRAM">Sequence diagram</option>
                                                            <option value="CLASS_DIAGRAM">Class diagram</option>
                                                            <option value="STATE_DIAGRAM">State diagram</option>
                                                            <option value="ENTITY_RELATIONSHIP_DIAGRAM">Entity-relationship diagram</option>
                                                            <option value="USER_JOURNEY">User journey</option>
                                                            <option value="GANTT">Gantt</option>
                                                            <option value="PIE_CHART">Pie chart</option>
                                                            <option value="QUADRANT_CHART">Quadrant chart</option>
                                                            <option value="REQUIREMENT_DIAGRAM">Requirement diagram</option>
                                                            <option value="GITGRAPH_DIAGRAM">Gitgraph diagram</option>
                                                            <option value="C4_DIAGRAM">C4 diagram</option>
                                                            <option value="MINDMAPS">Mindmaps</option>
                                                            <option value="TIMELINE">Timeline</option>
                                                            <option value="ZENUML">ZenUML</option>
                                                            <option value="SANKEY">Sankey</option>
                                                            <option value="XYCHART">XY chart</option>
                                                            <option value="BLOCKDIAGRAM">Block diagram</option>
                                                            <option value="PACKET">Packet</option>
                                                            <option value="KANBAN">Kanban</option>
                                                            <option value="ARCHITECTURE">Architecture</option>
                                                            <option value="RADAR">Radar</option>
                                                            <option value="TREEMAP">Treemap</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                {# publication_doi removed from per-file form: DOI will be added by backend #}
                                                <div class="col-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">Tags (separated by commas)</label>
                                                        <input type="text" class="form-control" name="mermaid_diagrams-${formUniqueId}-tags">
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">Mermaid version</label>
                                                        <input type="text" class="form-control" name="mermaid_diagrams-${formUniqueId}-version">
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="mb-3">
                                                        <label class="form-label">Authors</label>
                                                        <div id="` + formContainer.id + `_authors">
                                                        </div>
                                                        <button type="button" class="add_author_to_uvl btn btn-secondary" id="` + formContainer.id + `_authors_button">Add author</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    `;

                                listItem.appendChild(formContainer);
                                fileList.appendChild(listItem);

                            });

                                this.on('error', function (file, response) {
                                console.error("Error uploading file: ", response);
                                let alert = document.createElement('p');
                                alert.textContent = 'Mermaid not valid: ' + file.name;
                                alerts.appendChild(alert);
                                alerts.style.display = 'block';
                            });

                        }
                    };


                </script>

            </div>
        </div>

    </div>

    <div class="row" id="upload_dataset" style="display: none">

        <div class="col-12">

            <hr>

            <h1 class="h3 mb-3 mt-2">Upload dataset</h1>

            <div style="padding-left: 2rem">

                <label class="form-check">
                    <input id="agreeCheckbox" class="form-check-input" type="checkbox" value="">
                    <span class="form-check-label" style="font-size: 15px">
                                I agree to have my feature models automatically uploaded to Zenodo and made available to the public according to the <a
                            href="https://en.wikipedia.org/wiki/Open_science" target="_blank">Open Science</a> manifesto
                            </span>
                </label>

                <button id="upload_button" class="btn btn-primary mt-2" disabled>
                    <i data-feather="upload" class="center-button-icon"></i>
                    Upload dataset</button>

                <div id="loading" style="display: none">
                    <img width="40px" src="{{ url_for("static", filename="gifs/loading.svg") }}"/>
                    Uploading dataset, please wait...
                </div>

                <div class="row">
                    <div class="col-12 mb-3">

                    </div>
                </div>

                <div class="alert alert-error" role="alert" id="upload_error"
                     style="display: none">
                    <div class="alert-message">

                        <h4 class="alert-heading"><i class="align-middle" data-feather="alert-triangle"></i> Limited
                            connection to the Zenodo API</h4>
                        <p class="p-0 m-0">
                            There seems to be some kind of problem with the Zenodo API and synchronization of your
                            dataset
                            files may not be possible. We will save your files locally to eventually synchronize
                            them with
                            Zenodo. Sorry for the inconvenience, Zenodo is an external service and we can't do
                            anything about it.
                        </p>
                    </div>
                </div>


                <span class="text-danger mt-2" id="upload_error" style="display: none">

                    </span>

                <script>
                    const checkbox = document.getElementById('agreeCheckbox');
                    const upload_button = document.getElementById('upload_button');

                    checkbox.addEventListener('change', function () {
                        upload_button.disabled = !checkbox.checked;
                    });
                </script>

            </div>




        </div>

    </div>


{% endblock %}

{% block scripts %}
    <script src="{{ url_for('zenodo.scripts') }}"></script>
    <script src="{{ url_for('dataset.scripts') }}"></script>
{% endblock %}
